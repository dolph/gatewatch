{% extends "layout.html" %}
{% block script %}
    <script type="application/javascript">
        var GRAPH_URL = "http://graphite.openstack.org/render/?from=-24hours&width={{ 940 * 2 }}&height={{ 80 * 2 }}&margin=0&hideLegend=true&hideAxes=true&hideGrid=true&target=color(stats.gauges.zuul.pipeline.gate.current_changes,%20%27777777%27)&bgcolor=000000";

        // add a startswith function to all strings
        // http://stackoverflow.com/questions/646628
        if (typeof String.prototype.startswith != 'function') {
            String.prototype.startswith = function (str){
                return this.indexOf(str) == 0;
            };
        }

        function loadData() {
            $.getJSON("{{ url_for('data') }}",
                function(data) {
                    $('#open_reviews').html(data.open_reviews);

                    var gate_duration = data.gate_duration;
                    if (gate_duration[0] == 0) {
                        $('#gate_duration').html('<span class="text-success">Empty</span>');
                    } else if(gate_duration[1].startswith("second") || gate_duration[1].startswith("minute") || gate_duration[1].startswith("hour") && gate_duration[0] <= 6) {
                        $('#gate_duration').html('<span class="text-success">' + gate_duration[0] + ' <small>' + gate_duration[1] + '</small></span>');
                    } else if (gate_duration[1].startswith("hour")) {
                        $('#gate_duration').html('<span class="text-warning">' + gate_duration[0] + ' <small>' + gate_duration[1] + '</small></span>');
                    } else {
                        $('#gate_duration').html('<span class="text-error">' + gate_duration[0] + ' <small>' + gate_duration[1] + '</small></span>');
                    }

                    if (data.failed_merges) {
                        $('#failed_merges').html('<span class="text-warning">' + data.failed_merges + '</span>');
                    } else {
                        $('#failed_merges').html('<span class="muted">0</span>');
                    }

                    $('#next_milestone').html(data.next_milestone[0] + ' <small>' + data.next_milestone[1] + '</small>');

                    var s = '';
                    for (var i = 0; i < data.changes.length; i++) {
                        var change = data.changes[i];
                        s = s + '<tr>';
                        s = s + '<td><h3>' + change['eta'][0] + ' <small>' + change['eta'][1] + '</small></h3></td>';
                        s = s + '<td><h3><a href="' + change['url'] + '">' + change['subject'] + '</a></h3></td>';
                        s = s + '</tr>';
                    }
                    $('#changes').html(s);

                    $('#graph').attr('src', GRAPH_URL + '&' + new Date().getTime());
                }
            );
            setTimeout("loadData()", 30 * 1000);
        }
        $(document).ready(loadData);
    </script>
{% endblock %}
{% block body %}
    <div class="row">
        <div class="span12">
            <img id="graph" style="width: 940px; height: 80px;" />
        </div>
    </div>
    <div class="row">
        <div class="span3">
            <h4>Open Reviews</h4>
            <h1 id="open_reviews"></h1>
        </div>
        <div class="span3">
            <h4>Gate Queue</h4>
            <h1 id="gate_duration"></h1>
        </div>
        <div class="span3">
            <h4>Failed Merges</h4>
            <h1 id="failed_merges"></h1>
        </div>
        <div class="span3">
            <h4>Next Milestone</h4>
            <h1 id="next_milestone"></h1>
        </div>
    </div>
    <div class="row">
        <div class="span12">
            <table class="table table-condensed" id="changes"></table>
        </div>
    </div>
{% endblock %}
