- hosts: all
  tasks:
#   - name: deploy authorized key to root
#     authorized_key:
#       user=root
#       key="{{ lookup('file', '~/.ssh/id_rsa.pub') }}"

    - name: update apt cache
      apt:
        update_cache=yes

    - name: install apt packages
      apt:
        pkg={{ item }}
      with_items:
        - git
        - nginx
        - python-dev
        - python-setuptools
        - python-virtualenv
        - redis-server
        - supervisor

    - name: install pip
      easy_install:
        name=pip

    - name: create home dir for gatewatch user with ssh key
      user:
        name=gatewatch
        createhome=yes

- hosts: all
  sudo: True
  sudo_user: gatewatch
  tasks:
    - name: create directories
      file:
        dest={{ item }}
        state=directory
        mode=0700
      with_items:
        - ~/log
        - ~/.ssh

    - name: install public deploy key
      copy:
        src=~/.ssh/deploy.pub
        dest=~/.ssh/id_rsa.pub
        mode=0644

    - name: install private deploy key
      copy:
        src=~/.ssh/deploy
        dest=~/.ssh/id_rsa
        mode=0600

    - name: install git.dolphm.com known host
      copy:
        src=files/known_hosts
        dest=~/.ssh/known_hosts
        mode=0644

    - name: install pip packages into venv
      sudo_user: gatewatch
      pip:
        name={{ item }} state=latest
        virtualenv=/home/gatewatch/venv
      with_items:
        - pip
        - celery
        - gunicorn

    - name: deploy app config
      template:
        src=templates/config.py
        dest=~/gatewatch.conf.py
        mode=0700

- hosts: all
  tasks:
    - name: deploy celery config
      template:
        src=templates/supervisor.celery.conf
        dest=/etc/supervisor/conf.d/celery.conf

    - name: deploy gunicorn config
      template:
        src=templates/supervisor.gunicorn.conf
        dest=/etc/supervisor/conf.d/gunicorn.conf

    - name: deploy nginx config
      template:
        src=templates/nginx.vhost
        dest=/etc/nginx/sites-enabled/default
      notify: restart nginx

    - name: ensure supervised processes are present
      shell: /usr/bin/supervisorctl reread && /usr/bin/supervisorctl update

    - name: ensure nginx is running
      service:
        name=nginx
        enabled=yes
        state=started

  handlers:
    - name: restart nginx
      service:
        name=nginx
        state=reloaded

- include: deploy.yaml
